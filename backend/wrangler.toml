name = "skyreader-api"
main = "src/index.ts"
compatibility_date = "2025-09-27"

[observability]
enabled = true

# Durable Objects
[durable_objects]
bindings = [
  { name = "REALTIME_HUB", class_name = "RealtimeHub" },
  { name = "JETSTREAM_POLLER", class_name = "JetstreamPoller" },
  { name = "FEED_REFRESHER", class_name = "FeedRefresher" }
]

[[migrations]]
tag = "v1"
new_sqlite_classes = ["JetstreamConsumer"]

[[migrations]]
tag = "v2"
new_sqlite_classes = ["RealtimeHub"]

[[migrations]]
tag = "v3"
deleted_classes = ["JetstreamConsumer"]

[[migrations]]
tag = "v4"
new_sqlite_classes = ["JetstreamPoller", "FeedRefresher"]

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "skyreader"
database_id = "YOUR_D1_DATABASE_ID"

# Environment variables
[vars]
FRONTEND_URL = "https://skyreader.app"

# Cron Triggers
# - Every minute: Cleanup tasks, ensure JetstreamPoller running
# - Every 15 minutes: Trigger FeedRefresher cycle
[triggers]
crons = ["* * * * *", "*/15 * * * *"]

# Development environment
[env.dev]
vars = { FRONTEND_URL = "http://127.0.0.1:5173" }

# Staging environment
[env.staging]
name = "skyreader-api-staging"
vars = { FRONTEND_URL = "https://staging.skyreader.pages.dev" }
routes = [{ pattern = "api-staging.skyreader.app", custom_domain = true }]

[env.staging.durable_objects]
bindings = [
  { name = "REALTIME_HUB", class_name = "RealtimeHub" },
  { name = "JETSTREAM_POLLER", class_name = "JetstreamPoller" },
  { name = "FEED_REFRESHER", class_name = "FeedRefresher" }
]

[[env.staging.d1_databases]]
binding = "DB"
database_name = "skyreader-staging"
database_id = "YOUR_STAGING_D1_DATABASE_ID"

# Cron Triggers in staging
[env.staging.triggers]
crons = ["* * * * *", "*/30 * * * *"]
