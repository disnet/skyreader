name = "skyreader-api"
main = "src/index.ts"
compatibility_date = "2025-09-27"

[observability]
enabled = true

# Durable Objects for realtime hub
[durable_objects]
bindings = [
  { name = "REALTIME_HUB", class_name = "RealtimeHub" }
]

[[migrations]]
tag = "v1"
new_sqlite_classes = ["JetstreamConsumer"]

[[migrations]]
tag = "v2"
new_sqlite_classes = ["RealtimeHub"]

[[migrations]]
tag = "v3"
deleted_classes = ["JetstreamConsumer"]

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "skyreader"
database_id = "94dbfd9e-3e55-4551-a812-75ce4bc8339f"

# Environment variables
[vars]
FRONTEND_URL = "https://skyreader.app"

# Cron Triggers - run every minute for Jetstream polling
[triggers]
crons = ["* * * * *"]

# Development environment
[env.dev]
vars = { FRONTEND_URL = "http://127.0.0.1:5173" }

# Staging environment
[env.staging]
name = "skyreader-api-staging"
vars = { FRONTEND_URL = "https://staging.skyreader.pages.dev" }
routes = [{ pattern = "api-staging.skyreader.app", custom_domain = true }]

[[env.staging.d1_databases]]
binding = "DB"
database_name = "skyreader-staging"
database_id = "4319fd64-8868-48c9-b539-a4f4bc6d0c22"

# Disable cron in staging to avoid unnecessary background processing
[env.staging.triggers]
crons = []
